# Environment Migration Log: Moving from Pip/Venv to uv

## Context
The project initially used traditional python environment tools (`pip` and `venv`) for backend dependency management across local scaffolding, CI pipelines, and Docker builds. 
The user requested shifting entirely to `uv` ‚Äî Astral's ultra-fast Python package and project manager written in Rust, which can manage the dependency resolution, python versions, and environments natively faster.

---

## Detailed debugging and execution process

### 1. Identifying old `pip` usages
We started by finding all usages of "pip" across the project to replace them with `uv`.
- Command Executed: `grep -r "pip" .` (via codebase search tools)
- Files Found:
  - `README.md`
  - `.agents/rules.md`
  - `backend/Dockerfile`
  - `.github/workflows/ci.yml`

### 2. Installing `uv` Locally
- Command Executed: 
  ```bash
  curl -LsSf https://astral.sh/uv/install.sh | sh
  ```
- Output:
  ```
  downloading uv 0.10.6 aarch64-apple-darwin
  no checksums to verify
  installing to /Users/lishanshou/.local/bin
    uv
    uvx
  everything's installed!
  ```
- Explanation: Downloaded and installed the `uv` and `uvx` binaries locally to `~/.local/bin`.

### 3. File modifications

#### A. Updating `README.md` and `.agents/rules.md`
- Changes: Swapped out pip-based python instructions for `$ uv sync --all-extras` and backend execution via `$ uv run uvicorn`. Mentioned `uv pip audit` instead of `pip-audit`.
- Reason: Reflect the new developer workflow and project standards.

#### B. Updating `.github/workflows/ci.yml`
- Changes: 
  - Included a new GitHub Action: `astral-sh/setup-uv@v5` to drastically improve CI caching.
  - Substituted the run steps:
    - `pip install -e ".[dev]"` -> `uv sync --all-extras`
    - `ruff check .` -> `uv run ruff check .`
    - `black --check .` -> `uv run black --check .`
    - `pip-audit` -> `uv pip install pip-audit && uv run pip-audit`
    - `pytest` -> `uv run pytest`
- Reason: Using `uv run` in GitHub Actions ensures CI invokes tools inside the precise optimized `.venv` generated by `uv sync`.

#### C. Updating `backend/Dockerfile`
- Changes: 
  - Added: `COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/`
  - Updated: `RUN uv pip install --system -e ".[dev]"`
- Reason: Docker build speeds up significantly. Adding `--system` installs packages natively into the system Python within the container instead of building an unnecessary `.venv` inside the container image.

### 4. Running `uv sync`
- Command Executed:
  ```bash
  backend $ ~/.local/bin/uv sync --all-extras
  ```
- Output:
  ```
  warning: `VIRTUAL_ENV=venv` does not match the project environment path `.venv` and will be ignored; use `--active` to target the active environment instead
  Using CPython 3.11.9 interpreter at: /Users/lishanshou/.pyenv/versions/3.11.9/bin/python3
  Creating virtual environment at: .venv
  Prepared 176 packages in 6.58s
  Installed 176 packages in 571ms
  ```
- Explanation: The previous terminal session still had the old `venv` activated (hence the warning), but `uv` automatically created its own optimized `.venv` local environment directory and installed all 176 dependencies in under a second.

### 5. Running Tests with `uv`
- Command Executed:
  ```bash
  backend $ ~/.local/bin/uv run pytest tests/
  ```
- Output:
  ```
  ========================= test session starts =========================
  tests/integration/test_health.py .
  ERROR: Coverage failure: total of 79 is less than fail-under=80
  =========================== tests coverage ===========================
  app/api/routes/documents.py      61%
  app/workers/tasks.py              0%
  TOTAL                           79%
  FAIL Required test coverage of 80.0% not reached. Total coverage: 78.68%
  =================== 1 passed, 4 warnings in 0.06s ====================
  Exit code 1
  ```
- Explanation: The tests executed perfectly inside the new `uv` environment. The `TestClient` hit the health endpoint successfully (1 passed), but `pytest-cov` failed the suite because the line coverage is `78.68%` (our `.antigravityrules` strictness requires `80%`). We will need to write more tests for `documents.py` to fix the coverage failing. 
FastAPI framework yielded some warnings about replacing `on_event("startup")` with `lifespan` which we will address.

### 6. Removing Old Environment üóëÔ∏è
- Command Executed: `rm -rf venv`
- Explanation: Removed the old `venv` folder left over by the original `python -m venv` setup, relying cleanly on `uv`'s `.venv` going forward.
